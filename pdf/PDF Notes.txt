# PDF Service Implementation Notes

## Overview
The PDF service handles PDF file processing, text extraction, and integration with NLP services for resume analysis in the AI Resume Backend.

## Files in this Directory

### 1. pdf_service.py
Main service class for PDF processing and text extraction.

---

## pdf_service.py - Line by Line Explanation

### Imports and Initialization
```python
import PyPDF2
import os
from werkzeug.utils import secure_filename
from nlp.nlp_service import NLPService
from nlp.embedding_service import EmbeddingService
from database.database_service import DatabaseService
```
- PyPDF2: Library for reading and extracting text from PDF files
- os: File system operations for file handling
- werkzeug.utils.secure_filename: Sanitizes filenames for security
- NLPService: For text processing and skill extraction
- EmbeddingService: For generating text embeddings
- DatabaseService: For persisting processed resume data

```python
class PDFService:
    def __init__(self):
        self.nlp_service = NLPService()
        self.embedding_service = EmbeddingService()
        self.db_service = DatabaseService()
```
- PDFService class constructor
- Initializes NLP, embedding, and database services
- Services are created once and reused for efficiency

### PDF Text Extraction
```python
def extract_text_from_pdf(self, filepath):
    """Extract text from PDF using PyPDF2"""
    try:
        with open(filepath, 'rb') as file:
            reader = PyPDF2.PdfReader(file)
            text = ""
            for page in reader.pages:
                text += page.extract_text()
            return text
    except Exception as e:
        print(f"Error extracting text from PDF: {e}")
        return ""
```
- Main method for extracting text from PDF files
- Opens file in binary read mode ('rb')
- Creates PdfReader object to access PDF content
- Iterates through all pages and extracts text
- Concatenates text from all pages
- Handles errors gracefully and returns empty string on failure

### Resume Processing Pipeline
```python
def process_resume(self, file_path, filename):
    """Process uploaded resume PDF"""
    try:
        # Extract text from PDF
        text_content = self.extract_text_from_pdf(file_path)
        
        if not text_content.strip():
            return {
                'error': 'Could not extract text from PDF',
                'success': False
            }
```
- Main entry point for resume processing
- Calls extract_text_from_pdf to get text content
- Validates that text was successfully extracted
- Returns error response if no text found

```python
# Extract skills and keywords using NLP
nlp_result = self.nlp_service.extract_skills_and_keywords(text_content)
skills = nlp_result.get('SKILL', [])
keywords = nlp_result.get('KEYWORDS', [])
```
- Calls NLP service to analyze extracted text
- Extracts skills and keywords from NLP results
- Uses .get() with default empty list for safety

```python
# Generate embedding for the resume text
embedding_result = self.embedding_service.generate_embedding(text_content)
embedding = embedding_result.get('embedding', [])
```
- Generates embedding vector for resume text
- Uses embedding service for similarity matching
- Extracts embedding array from result

```python
# Calculate ATS score
ats_score = self._calculate_ats_score(text_content, skills, keywords)
```
- Calculates ATS score using internal method
- Passes text, skills, and keywords for scoring
- Returns numeric score (0-100)

```python
# Save to database
resume_data = {
    'filename': filename,
    'text_content': text_content,
    'skills': skills,
    'keywords': keywords,
    'embedding': embedding,
    'ats_score': ats_score
}

resume_id = self.db_service.save_resume(resume_data)
```
- Prepares resume data dictionary for storage
- Includes all extracted and calculated information
- Saves to database and gets generated ID

```python
return {
    'resume_id': resume_id,
    'filename': filename,
    'skills': skills,
    'keywords': keywords,
    'ats_score': ats_score,
    'success': True
}
```
- Returns success response with processed data
- Includes resume ID for reference
- Provides extracted skills, keywords, and score

### ATS Score Calculation
```python
def _calculate_ats_score(self, text_content, skills, keywords):
    """Calculate basic ATS score based on content analysis"""
    score = 0
    
    # Base score for having content
    if len(text_content.strip()) > 100:
        score += 20
```
- Internal method for ATS scoring
- Starts with 0 points
- Awards 20 points for substantial content (>100 chars)

```python
# Skills score (up to 40 points)
if len(skills) > 0:
    skill_score = min(40, len(skills) * 5)
    score += skill_score
```
- Awards points for extracted skills
- 5 points per skill, max 40 points
- Uses min() to cap at maximum

```python
# Keywords score (up to 30 points)
if len(keywords) > 0:
    keyword_score = min(30, len(keywords) * 2)
    score += keyword_score
```
- Awards points for extracted keywords
- 2 points per keyword, max 30 points
- Encourages keyword-rich resumes

```python
# Structure score (up to 10 points)
if any(section in text_content.lower() for section in ['experience', 'education', 'skills']):
    score += 10
```
- Awards 10 points for proper resume structure
- Checks for common resume sections
- Case-insensitive search in text

```python
return min(100, score)
```
- Returns final score capped at 100
- Uses min() to ensure score doesn't exceed maximum

### File Validation
```python
def validate_pdf_file(self, file):
    """Validate uploaded PDF file"""
    if not file:
        return False, "No file provided"
    
    if not file.filename:
        return False, "No filename provided"
```
- Validates uploaded file object
- Checks if file exists and has filename
- Returns boolean and error message

```python
# Check file extension
if not file.filename.lower().endswith('.pdf'):
    return False, "File must be a PDF"
```
- Ensures file has .pdf extension
- Case-insensitive check
- Returns error if not PDF

```python
# Check file size (max 16MB)
file.seek(0, os.SEEK_END)
file_size = file.tell()
file.seek(0)
    
if file_size > 16 * 1024 * 1024:
    return False, "File too large (max 16MB)"
```
- Checks file size to prevent abuse
- Seeks to end to get size, then resets position
- 16MB limit for reasonable resume files

```python
return True, "File is valid"
```
- Returns success if all checks pass
- Indicates file is ready for processing

### Batch Processing
```python
def batch_process_resumes(self, directory_path):
    """Process all PDF files in a directory"""
    processed_files = []
    errors = []
    
    if not os.path.exists(directory_path):
        return processed_files, ["Directory not found"]
```
- Processes multiple PDF files in directory
- Returns lists of processed files and errors
- Validates directory exists first

```python
for filename in os.listdir(directory_path):
    if filename.lower().endswith('.pdf'):
        file_path = os.path.join(directory_path, filename)
        
        try:
            result = self.process_resume(file_path, filename)
            if result['success']:
                processed_files.append(result)
            else:
                errors.append(f"{filename}: {result.get('error', 'Unknown error')}")
        except Exception as e:
            errors.append(f"{filename}: {str(e)}")
```
- Iterates through directory contents
- Filters for .pdf files only
- Processes each file individually
- Collects successful results and errors separately
- Handles exceptions for each file individually

```python
return processed_files, errors
```
- Returns both successful and failed results
- Allows caller to handle both cases

## How PDF Service Works

### Processing Pipeline
1. **File Upload**: User uploads PDF through API
2. **Validation**: File checked for size, type, and integrity
3. **Text Extraction**: PyPDF2 extracts text from all pages
4. **NLP Analysis**: Text processed for skills and keywords
5. **Embedding Generation**: Text converted to vector representation
6. **ATS Scoring**: Resume scored against criteria
7. **Database Storage**: All results saved for future reference

### Error Handling
- **File Errors**: Invalid files rejected with clear messages
- **Extraction Errors**: Empty PDFs detected and reported
- **Processing Errors**: Individual step failures don't crash entire process
- **Database Errors**: Storage failures handled gracefully

### Security Considerations
- **Filename Sanitization**: Uses secure_filename to prevent path traversal
- **File Size Limits**: Prevents denial of service with large files
- **Type Validation**: Ensures only PDF files are processed
- **Error Messages**: Generic error messages prevent information leakage

### Performance Optimizations
- **Service Reuse**: NLP and embedding services created once
- **Batch Processing**: Can handle multiple files efficiently
- **Early Validation**: Catches errors before expensive processing
- **Memory Management**: File handles properly closed

## Usage Examples

### Single File Processing
```python
pdf_service = PDFService()
result = pdf_service.process_resume('resume.pdf', 'resume.pdf')
if result['success']:
    print(f"Processed resume {result['resume_id']} with score {result['ats_score']}")
else:
    print(f"Error: {result['error']}")
```

### File Validation
```python
is_valid, message = pdf_service.validate_pdf_file(uploaded_file)
if is_valid:
    # Process file
else:
    print(f"Invalid file: {message}")
```

### Batch Processing
```python
processed, errors = pdf_service.batch_process_resumes('/path/to/pdfs')
print(f"Processed {len(processed)} files")
print(f"Errors in {len(errors)} files")
```

## Integration Points

### With NLP Service
- Provides text content for analysis
- Receives structured skill/keyword extraction
- Uses results for ATS scoring

### With Embedding Service
- Sends resume text for vector conversion
- Receives embedding for job matching
- Enables similarity calculations

### With Database Service
- Stores complete resume data
- Includes processed results and metadata
- Enables future retrieval and analysis

### With Flask API
- Called from upload endpoints
- Returns structured JSON responses
- Handles file upload validation

## Key Features
- **Robust Text Extraction**: Handles various PDF formats
- **Comprehensive Analysis**: Skills, keywords, and scoring
- **Error Resilience**: Graceful handling of edge cases
- **Security Focused**: File validation and sanitization
- **Scalable Design**: Batch processing capabilities
- **Integration Ready**: Clean interfaces with other services
